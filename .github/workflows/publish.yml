name: Publish to npm

on:
  release:
    types: [published]

jobs:
  publish:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'
          registry-url: 'https://registry.npmjs.org'

      - name: Install dependencies
        run: npm ci

      - name: Build
        run: npm run build

      - name: Publish to npm
        run: npm publish --access public
        env:
          NODE_AUTH_TOKEN: ${{ secrets.NPM_TOKEN }}

      - name: Get version from package.json
        id: version
        run: echo "version=$(node -p 'require("./package.json").version')" >> "$GITHUB_OUTPUT"

      - name: Update LATEST_CLI_VERSION on Vercel
        run: |
          npm install -g vercel
          for env in production preview development; do
            vercel env rm LATEST_CLI_VERSION "$env" --yes --token "$VERCEL_TOKEN" --scope "$VERCEL_ORG_ID" 2>/dev/null || true
            echo "${{ steps.version.outputs.version }}" | vercel env add LATEST_CLI_VERSION "$env" --token "$VERCEL_TOKEN" --scope "$VERCEL_ORG_ID"
          done
        env:
          VERCEL_TOKEN: ${{ secrets.VERCEL_TOKEN }}
          VERCEL_ORG_ID: team_ZWvwlzfFy5lHj9GDpSnOzBAZ
          VERCEL_PROJECT_ID: prj_SawD8XnMTdlOc5x1Vl3nEMLbGhXX

      - name: Trigger Vercel redeploy
        if: ${{ secrets.VERCEL_DEPLOY_HOOK != '' }}
        run: curl -s -X POST "${{ secrets.VERCEL_DEPLOY_HOOK }}"
